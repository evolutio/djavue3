---
description: Padr√£o de Services Django - Regras de Neg√≥cio
globs:
  - "**/service/**/*.py"
alwaysApply: false
---

# üì¶ Services Django - DjaVue

## Princ√≠pios

Services cont√™m **regras de neg√≥cio** e devem ser:
- **Python puro** (n√£o dependem do Django, exceto models)
- **Facilmente test√°veis** (sem depend√™ncias de request/response)
- **Reutiliz√°veis** (podem ser chamados de views, tasks, outros services)

## Estrutura

### Organiza√ß√£o
- Services ficam na pasta `service/` de cada app
- Um arquivo por contexto: `[nome]_svc.py`
- Exportar fun√ß√µes no `__init__.py` da pasta `service/`

### Nomenclatura
- Arquivo: `[nome]_svc.py` (ex: `task_svc.py`, `user_svc.py`)
- Fun√ß√µes: `snake_case` (ex: `add_task()`, `list_tasks()`)
- Importa√ß√£o: `from .service import [nome]_svc`

## Padr√£o de Fun√ß√µes

### Fun√ß√µes de Cria√ß√£o
```python
def add_[entity](data: Type) -> dict:
    """
    Adiciona nova [entity]
    
    Args:
        data: Dados da entidade
        
    Returns:
        dict: Entidade criada (resultado de to_dict_json())
        
    Raises:
        BusinessError: Se dados inv√°lidos
    """
    logger.info("SERVICE add new [entity]")
    
    # Valida√ß√£o
    if not data or not data.strip():
        raise BusinessError("Invalid data")
    
    # L√≥gica de neg√≥cio
    entity = Entity(data=data)
    entity.save()
    
    logger.info("SERVICE [entity] created.")
    return entity.to_dict_json()
```

### Fun√ß√µes de Listagem
```python
def list_[entities]() -> list:
    """
    Lista todas as [entities]
    
    Returns:
        list: Lista de entidades (resultado de to_dict_json())
    """
    logger.info("SERVICE list [entities]")
    entities = Entity.objects.all()
    return [item.to_dict_json() for item in entities]
```

### Fun√ß√µes de Atualiza√ß√£o
```python
def update_[entity](entity_id: int, data: Type) -> dict:
    """
    Atualiza [entity] existente
    
    Args:
        entity_id: ID da entidade
        data: Novos dados
        
    Returns:
        dict: Entidade atualizada
        
    Raises:
        BusinessError: Se entidade n√£o encontrada ou dados inv√°lidos
    """
    logger.info(f"SERVICE update [entity] {entity_id}")
    
    try:
        entity = Entity.objects.get(id=entity_id)
    except Entity.DoesNotExist:
        raise BusinessError("Entity not found")
    
    # Valida√ß√£o e atualiza√ß√£o
    if data:
        entity.data = data
        entity.save()
    
    logger.info(f"SERVICE [entity] {entity_id} updated.")
    return entity.to_dict_json()
```

### Fun√ß√µes de Exclus√£o
```python
def delete_[entity](entity_id: int) -> bool:
    """
    Remove [entity]
    
    Args:
        entity_id: ID da entidade
        
    Returns:
        bool: True se removido com sucesso
        
    Raises:
        BusinessError: Se entidade n√£o encontrada
    """
    logger.info(f"SERVICE delete [entity] {entity_id}")
    
    try:
        entity = Entity.objects.get(id=entity_id)
        entity.delete()
        logger.info(f"SERVICE [entity] {entity_id} deleted.")
        return True
    except Entity.DoesNotExist:
        raise BusinessError("Entity not found")
```

## Valida√ß√µes

- Sempre validar entrada antes de processar
- Usar exce√ß√µes `BusinessError` para erros de neg√≥cio
- Validar tipos, valores, regras de neg√≥cio
- Mensagens de erro claras e descritivas

## Logging

- Sempre usar logging em services
- Padr√£o: `logger = logging.getLogger(__name__)`
- Logar in√≠cio e fim de opera√ß√µes importantes
- Incluir IDs ou identificadores relevantes

## Testes

- Services devem ser **altamente test√°veis**
- Escrever testes unit√°rios para cada fun√ß√£o
- Mockar depend√™ncias externas (banco, APIs)
- Testar casos de sucesso e erro

## Exemplo Completo

```python
import logging
from ..models import Task
from ...base.exceptions import BusinessError

logger = logging.getLogger(__name__)

def add_task(description: str) -> dict:
    """Adiciona nova tarefa"""
    logger.info("SERVICE add new task")
    
    # Valida√ß√£o
    if not isinstance(description, str):
        raise BusinessError("Invalid description")
    
    if not description or not description.strip():
        raise BusinessError("Invalid description")
    
    # L√≥gica de neg√≥cio
    task = Task(description=description)
    task.save()
    
    logger.info("SERVICE task created.")
    return task.to_dict_json()

def list_tasks():
    """Lista todas as tarefas"""
    logger.info("SERVICE list tasks")
    tasks = Task.objects.all()
    return [item.to_dict_json() for item in tasks]
```
